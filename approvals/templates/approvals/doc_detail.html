{% extends "base.html" %}
{% block content %}
<h1>문서 상세</h1>

<div class="card">
  <p><span class="badge">{{ doc.get_status_display }}</span> 문서ID: {{ doc.id }}</p>
  <h2>{{ doc.title }}</h2>
  <p class="muted">작성자: {{ doc.created_by.profile.full_name|default:doc.created_by.username }} / 작성: {{ doc.created_at|date:"Y-m-d H:i" }}</p>
  <hr/>
  <div style="white-space: pre-wrap;">{{ doc.content }}</div>
</div>

<div class="card">
  <h3>첨부파일</h3>
  <ul>
    {% for a in doc.attachments.all %}
      <li>
  <a href="{% url 'approvals:attachment_download' a.id %}">
    {{ a.file.name }}
  </a>
  (업로드: {{ a.uploaded_by.profile.display_name|default:a.uploaded_by.username }})
</li>
    {% empty %}
      <li>첨부 없음</li>
    {% endfor %}
  </ul>
</div>

<div class="card">
  <h3>결재선</h3>
  <table class="table">
    <thead>
      <tr>
        <th>구분</th><th>순서</th><th>담당</th><th>상태</th><th>코멘트</th><th>처리시간</th>
      </tr>
    </thead>
    <tbody>
      {% for line in doc.lines.all %}
      <tr>
        <td>{{ line.get_role_display }}</td>
        <td>{{ line.order }}</td>
        <td>{{ line.user.profile.display_name|default:line.user.username }}</td>
        <td>{{ line.get_decision_display }}</td>
        <td>{{ line.comment }}</td>
        <td>{% if line.acted_at %}{{ line.acted_at|date:"Y-m-d H:i" }}{% endif %}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if current_line %}
<div class="card">
  <h3>현재 처리 단계</h3>
  <p>
    현재 단계: <b>{{ current_line.get_role_display }}</b>
    / 담당: <b>{{ current_line.user.profile.display_name|default:current_line.user.username }}</b>
  </p>

  {% if can_act and doc.status == "IN_PROGRESS" %}
  <form method="post" action="{% url 'approvals:act_approve' doc.id %}">
    {% csrf_token %}
    <label>코멘트(선택)</label>
    <input type="text" name="comment" />
    <div class="actions" style="margin-top:10px;">
      <button class="primary" type="submit">승인/협의완료</button>
    </div>
  </form>

  <form method="post" action="{% url 'approvals:act_reject' doc.id %}" style="margin-top:10px;">
    {% csrf_token %}
    <label>반려 사유(필수)</label>
    <input type="text" name="comment" required />
    <div class="actions" style="margin-top:10px;">
      <button type="submit">반려</button>
    </div>
  </form>
  {% endif %}
</div>
{% endif %}

{% endblock %}
