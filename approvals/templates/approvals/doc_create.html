{% extends "base.html" %}
{% block title %}문서 상신 | 전자결재{% endblock %}

{% block content %}
  <div class="card" style="max-width:900px; margin: 0 auto;">
    <h2 style="margin-top:0;">문서 상신</h2>

    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="msg error">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      <div class="field">
        <label for="{{ form.title.id_for_label }}">제목</label>
        {{ form.title }}
        {% if form.title.errors %}<div class="help" style="color:#dc2626;">{{ form.title.errors }}</div>{% endif %}
      </div>

      <div class="field">
        <label for="{{ form.content.id_for_label }}">내용</label>
        {{ form.content }}
        {% if form.content.errors %}<div class="help" style="color:#dc2626;">{{ form.content.errors }}</div>{% endif %}
      </div>

      <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
        <div class="field">
          <label for="{{ form.consultants.id_for_label }}">협의자</label>
          {{ form.consultants }}
          <div class="help">필요 시 여러 명 선택</div>
          {% if form.consultants.errors %}<div class="help" style="color:#dc2626;">{{ form.consultants.errors }}</div>{% endif %}
        </div>

        <div class="field">
          <label for="{{ form.approvers.id_for_label }}">결재자(순서대로)</label>

          {# ✅ hidden: 선택 순서를 서버로 보냄 #}
          {{ form.approvers_order }}

          {{ form.approvers }}
          <div class="help">{{ form.approvers.help_text }}</div>
          <div class="help" id="approver_order_hint" style="margin-top:6px;">
            선택 순서: <span class="mono" id="approver_order_text">-</span>
          </div>
          {% if form.approvers.errors %}<div class="help" style="color:#dc2626;">{{ form.approvers.errors }}</div>{% endif %}
        </div>
      </div>

      <div class="field">
        <label for="{{ form.receivers.id_for_label }}">수신/열람자</label>
        {{ form.receivers }}
        <div class="help">완료 후 열람자(수신자) 목록</div>
        {% if form.receivers.errors %}<div class="help" style="color:#dc2626;">{{ form.receivers.errors }}</div>{% endif %}
      </div>

      <div class="field">
        <label for="{{ form.files.id_for_label }}">첨부파일</label>
        {{ form.files }}
        <div class="help">여러 파일 선택 가능</div>
        {% if form.files.errors %}<div class="help" style="color:#dc2626;">{{ form.files.errors }}</div>{% endif %}
      </div>

      <div class="row" style="margin-top:14px;">
        <button class="btn btn-primary" type="submit">상신하기</button>
        <a class="btn" href="{% url 'approvals:home' %}">취소</a>
      </div>
    </form>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", function () {

    // ===== 공통: option 찾기(모바일 fallback 포함) =====
    function getOptionFromPointer(sel, e) {
      if (e.target && typeof e.target.closest === "function") {
        const opt = e.target.closest("option");
        if (opt && opt.parentElement === sel) return opt;
      }
      const rect = sel.getBoundingClientRect();
      const y = e.clientY - rect.top;
      const approxLineHeight = 20;
      const idx = Math.floor(y / approxLineHeight);
      if (idx >= 0 && idx < sel.options.length) return sel.options[idx];
      return null;
    }

    function enableToggle(selectId, onToggle) {
      const sel = document.getElementById(selectId);
      if (!sel || !sel.multiple) return;

      sel.addEventListener("pointerdown", function (e) {
        const opt = getOptionFromPointer(sel, e);
        if (!opt) return;

        e.preventDefault();
        opt.selected = !opt.selected;
        sel.dispatchEvent(new Event("change", { bubbles: true }));

        if (typeof onToggle === "function") onToggle(sel, opt);
      });
    }

    // ===== ✅ 결재자 순서 관리 =====
    const approverSel = document.getElementById("id_approvers");
    const orderHidden = document.getElementById("id_approvers_order");
    const orderText = document.getElementById("approver_order_text");

    // 선택 순서를 "id 문자열" 배열로 유지
    let approverOrder = [];

    function selectedIds(sel) {
      const ids = [];
      for (const opt of sel.options) {
        if (opt.selected) ids.push(opt.value);
      }
      return ids;
    }

    function syncApproverOrderFromSelection() {
      if (!approverSel) return;

      const selected = new Set(selectedIds(approverSel));

      // 1) 기존 order에서 "선택 해제된 것" 제거
      approverOrder = approverOrder.filter(id => selected.has(id));

      // 2) 새로 선택된 것(기존 order에 없는 것)을 뒤에 추가
      for (const id of selected) {
        if (!approverOrder.includes(id)) approverOrder.push(id);
      }

      // 3) hidden에 저장 (콤마)
      if (orderHidden) orderHidden.value = approverOrder.join(",");

      // 4) 화면 힌트 표시 (이름 텍스트)
      if (orderText) {
        if (approverOrder.length === 0) {
          orderText.textContent = "-";
        } else {
          const idToLabel = {};
          for (const opt of approverSel.options) idToLabel[opt.value] = opt.textContent.trim();
          orderText.textContent = approverOrder.map((id, i) => `${i+1}.${idToLabel[id] || id}`).join("  →  ");
        }
      }
    }

    if (approverSel) {
      // 초기 로딩 시(서버 validation 에러로 재렌더링 되는 경우 대비)
      // 이미 selected 된 값들을 DOM 순서대로 기본 세팅
      approverOrder = selectedIds(approverSel);
      syncApproverOrderFromSelection();

      approverSel.addEventListener("change", syncApproverOrderFromSelection);
    }

    // ===== 기존 토글 유지 + 결재자 토글 시에도 순서 동기화 =====
    enableToggle("id_consultants");
    enableToggle("id_receivers");
    enableToggle("id_approvers", function () {
      syncApproverOrderFromSelection();
    });
  });
  </script>
{% endblock %}