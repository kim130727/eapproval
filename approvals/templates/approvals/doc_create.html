{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
  <h2>문서 작성</h2>

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <div>
      {{ form.title.label_tag }}
      {{ form.title }}
      {{ form.title.errors }}
    </div>

    <div>
      {{ form.content.label_tag }}
      {{ form.content }}
      {{ form.content.errors }}
    </div>

    <div>
      {{ form.consultants.label_tag }}
      {{ form.consultants }}
      {{ form.consultants.errors }}
    </div>

    <div>
      {{ form.approvers.label_tag }}
      {{ form.approvers }}
      {% if form.approvers.help_text %}
        <small class="muted">{{ form.approvers.help_text }}</small>
      {% endif %}
      {{ form.approvers.errors }}
    </div>

    <div>
      {{ form.receivers.label_tag }}
      {{ form.receivers }}
      {{ form.receivers.errors }}
    </div>

    <div>
      {{ form.files.label_tag }}
      {{ form.files }}
      {{ form.files.errors }}
    </div>

    {{ form.as_p }}
    <button type="submit">상신</button>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

  function enableToggle(selectId) {
    const sel = document.getElementById(selectId);
    if (!sel) return;
    if (!sel.multiple) return;

    // 모바일 터치/펜/마우스 모두: pointerdown
    sel.addEventListener("pointerdown", function (e) {
      // option을 안정적으로 찾기
      let opt = null;

      // 1) 대부분 브라우저: target이 option(또는 option에 가까운 노드)
      if (e.target && typeof e.target.closest === "function") {
        const found = e.target.closest("option");
        if (found && found.parentElement === sel) opt = found;
      }

      // 2) 일부 환경 fallback: 좌표 기반 대략 index 추정
      if (!opt) {
        const rect = sel.getBoundingClientRect();
        const y = e.clientY - rect.top;
        const approxLineHeight = 20; // 대략 값(기본 select에서 충분)
        const idx = Math.floor(y / approxLineHeight);
        if (idx >= 0 && idx < sel.options.length) opt = sel.options[idx];
      }

      if (!opt) return;

      // ✅ 기본 동작을 막고 "클릭+클릭" 토글로 강제
      e.preventDefault();
      opt.selected = !opt.selected;
      sel.dispatchEvent(new Event("change", { bubbles: true }));
    });
  }

  enableToggle("id_consultants");
  enableToggle("id_approvers");
  enableToggle("id_receivers");
});
</script>

{% endblock %}
